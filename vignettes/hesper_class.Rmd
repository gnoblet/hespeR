---
title: "hesper_class"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{hesper_class}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(hespeR)
```

# Overview of hespeR S7 Classes

The `hespeR` package provides a set of `S7` classes to structure and validate incoming survey data. Why so restrictive? Restricting to these classes ensures that only valid operations are performed, prevents accidental misuse, and allows for the development of reusable and readable methods, towards semi-automated reports. This design makes it easier to extend functionality through methods if needed.

This said, helper functions are provided to convert from and to base R objects (e.g., data frames, lists) that will be linked to a default template of an XML Kobo tool.

## Main Classes

### `HesperVector`

Represents a single HESPER item. Main features to note are:
- `hesper_var`: the variable name of the HESPER item to which this vector corresponds.
- `hesper_vals`: the values for this variable. It can contain `NA` values if `allow_missing = TRUE`.

```{r}
hv <- HesperVector(
  hesper_var = "hesper_food",
  hesper_vals = c(
    "no_serious_problem",
    "serious_problem",
    NA,
    "dnk",
    "pnta",
    "serious_problem"
  ),
  allow_missing = TRUE
)
hv
```

You've just seen printed that there is a `@hesper_bins` property. A getter function adds `@hesper_bins` to the object, which are the binary indicators (1/0) for each possible response option. Binary variables will be useful for further analysis (faster, simpler).

To access values for instance, you can simply run `hv@hesper_vals` or `S7::props(hv, "hesper_vals")`.

Note that `hesper_vals` and `hesper_var` can only take a certain set of values, otherwise an error is thrown. This is to ensure that only valid data is processed. Values are stored as functions returning character vectors.

```{r}
# Variables/items
hesper_vars()

# Values/options
hesper_opts()
```

### `HesperList`

A list of `HesperVector` objects, representing a set of variables for an individual or group. It inherits the validator for each `HesperVector` and adds a few more checks (for instance it checks that there are no duplicated HESPER item names nor different lengths of vectors of values).

```{r}
hv2 <- HesperVector(
  hesper_var = "hesper_displaced",
  hesper_vals = c(
    "no_serious_problem",
    "serious_problem",
    "no_serious_problem",
    "dnk",
    "pnta",
    "serious_problem"
  ),
  allow_missing = TRUE
)
hl <- HesperList(hesper_list = list(hv, hv2))
hl
```


### `SL` (Skip Logic)

Often, there would be other variables collected as part of a survey, for instance demographic variables about the respondent or the household. These variables can be used to define skip logic rules, specifying when certain HESPER items should be set to missing based on the values of these other variables. 

A few examples are:

- If the person does not have children, then the 12th HESPER item about education for the children should be set to missing; or, 
- for healthcare, there are different questions depending on the gender of the respondent (e.g. access to maternal healthcare); or,
- the 16th HESPER item about displacement from home should only be asked to those who have suffered forced displacement.

As such, there is a need for a class to define skip logic rules, specifying when values should be set to missing based on other variables.

```{r}
sl_rule <- SL(
  hesper_var = "hesper_displaced",
  subset_var = "pop_group",
  subset_vals = c("host", "non_displaced")
)
sl_rule
```


### `HesperPriorities`

The `HesperPriorities` class is a simple class made of three properties which are character vectors of top1, top2, and top3 priority needs.

```{r}
hp <- HesperPriorities(
  top1 = c("hesper_food", "hesper_drinking_water"),
  top2 = c("hesper_shelter", "hesper_health"),
  top3 = c("hesper_education", "hesper_food")
)
hp
```

This class alone is not very useful, but it can be used as part of a `HesperListEnhanced` object to represent the top priority problems identified by the respondent. By itself, it simply checks that the values provided are valid HESPER item names and cannot be identical for one respondent, e.g. if the first position were to be: `top1 = "hesper_food"` and `top2 = "hesper_food"`, it would throw an error.

### `HesperListEnhanced`

Eventually, the last class `HesperListEnhanced` extends `HesperList` by adding skip logic (`SL`), top priorities (`HesperPriorities`), and other variables (e.g., demographic variables). This class is the most useful as it represents a full survey response, including HESPER items, skip logic rules, top priorities, and other variables.

```{r}
hle <- HesperListEnhanced(
  hesper_list = hl@hesper_list,
  other_list = list(
    pop_group = c("host", "refugee", "non_displaced", "host", "refugee", "host")
  ),
  SL = list(sl_rule)
)
```

It inherits all the validators from `HesperList`, and adds a few more checks, for instance that the `other_list` variables are of the same length as the HESPER items, or that the skip logic rules refer to valid variables.

As such an very initial method to be used and added to the object is `apply_hesper_list_sl()`, which applies the skip logic rules to the `HesperListEnhanced` object, setting values to `NA` where appropriate and return the object it-`self`.

```{r}

hle <- apply_hesper_list_sl(hle)
hle
```

### Methods to convert a data.frame to a `HesperListEnhanced` object

A few helper methods are provided to convert a data.frame from and to a `HesperList` or a `HesperListEnhanced` object. See [from_data.frame] and [as_data_frame] for more details.

Here is an example of converting a data.frame to a `HesperListEnhanced` object:
```{r}
df <- data.frame(
  # ----- HESPER items (must contain at least one "serious_problem" per row -----
  hesper_food = c(
    "serious_problem",
    "no_serious_problem",
    "serious_problem",
    "serious_problem",
    "no_serious_problem",
    "serious_problem"
  ),
  hesper_displaced = c(
    "no_serious_problem",
    "serious_problem",
    "serious_problem",
    "no_serious_problem",
    "serious_problem",
    "serious_problem"
  ),
  hesper_shelter = c(
    "no_serious_problem",
    "serious_problem",
    "no_serious_problem",
    "serious_problem",
    "serious_problem",
    "no_serious_problem"
  ),
  hesper_health = c(
    "serious_problem",
    "no_serious_problem",
    "no_serious_problem",
    "serious_problem",
    "serious_problem",
    "no_serious_problem"
  ),

  # ----- auxiliary variable (just to show that other_list works) -----
  pop_group = c("host", "refugee", "non_displaced", "host", "refugee", "host"),

  # ----- PRIORITY columns – each points to a *serious_problem* in the same row -----
  hesper_top1 = c(
    "hesper_food", # row 1 → food is serious
    "hesper_displaced", # row 2 → displaced is serious
    "hesper_displaced", # row 3 → displaced is serious
    "hesper_shelter", # row 4 → shelter is serious
    "hesper_displaced", # row 5 → displaced is serious
    "hesper_food"
  ), # row 6 → food is serious

  hesper_top2 = c(
    "hesper_health", # row 1 → health is serious
    NA, # row 2 → food is serious
    "hesper_food", # row 3 → food is serious
    "hesper_health", # row 4 → health is serious
    "hesper_health", # row 5 → health is serious
    "hesper_displaced"
  ), # row 6 → displaced is serious

  hesper_top3 = c(
    NA, # row 1 → displaced is serious
    "hesper_shelter", # row 2 → shelter is serious
    NA, # row 3 → shelter is serious
    "hesper_food", # row 4 → food is serious
    "hesper_shelter", # row 5 → shelter is serious
    NA
  ) # row 6 → displaced is serious
)
hle2 <- from_data_frame(
  df = df,
  hesper_vars = c(
    "hesper_food",
    "hesper_displaced",
    "hesper_shelter",
    "hesper_health"
  ),
  other_vars = c("pop_group"),
  priority_vars = c("hesper_top1", "hesper_top2", "hesper_top3")
)
```